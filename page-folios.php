<?php/** * The template for displaying the Folio page * * @link https://developer.wordpress.org/themes/basics/template-hierarchy/#single-post * * @package Ayin * @since 1.0.0 */get_header();?><section id="primary" class="content-area">	<main id="main" class="site-main" role="main"><?php		// define these two variables here so we can access them in JavaScript at bottom of file		$defaultImage = '';		$defaultCaption = '';		while ( have_posts() ) : ?>		<article id="post-<?php the_ID(); ?>" <?php post_class(); ?>>			<div class="entry-content"><?php				wp_reset_postdata();				the_post();				the_content(					sprintf(						wp_kses(						/* translators: %s: Name of current post. Only visible to screen readers */							__( 'Continue reading<span class="screen-reader-text"> "%s"</span>', 'ayin' ),							array(								'span' => array(									'class' => array(),								),							)						),						get_the_title()					)				);				echo(				'<div class="folios-page-container alignwide">						<div class="folios-grid">							<div class="folios-column">'				);				$all_categories = get_categories( array(					'parent' => '0' //get top level categories only				));				// look for the category id for the "Folio" category only				$folioCatId = 0;				$child_cats = null;				foreach( $all_categories as $single_category ){					if ($single_category->slug == 'folio') {						$folioCatId = $single_category->cat_ID;					}				}				// get children of "Folio" category only				if ($folioCatId > 0) {					$child_cats = get_categories( array(						'child_of' => $folioCatId						//category_display_order					));				}				// display list of folio categories and the posts associated with each				if ($child_cats) {					// first, get them in the right order (reverse display order, so highest number first					$sorted_cats = array();					foreach($child_cats as $cat){						$sorted_cats[] = array(							'd' => get_field('category_date_field', 'category_' . $cat->term_id),							'cat' => $cat						);					}					// sort by date using custom function at bottom of this file					usort($sorted_cats, 'date_compare');					// second, display each folio					$firstItem = true;					$firstCatId = 0;					$folioParentJS = '';					echo '<ul class="FolioChildren">';					foreach( $sorted_cats as $child_cat ) {						$childID = $child_cat['cat']->cat_ID;						if (!empty($child_cat['d'])) {							$folioDate = DateTime::createFromFormat('m/d/Y', $child_cat['d']);						} else {							$folioDate = null;						}						// add item to JS used below to map folio name to category Id						$folioParentJS .= 'if (folioSlug == \'' . $child_cat['cat']->slug . '\') catId = ' . $childID . ';' . "\r\n";						// get list of all posts within this category and set folio category settings						$folioName = $child_cat['cat']->name;						$folioImagePath = '';						$sorted_posts = array();						$posts = get_posts( array(							'cat' => $childID,							'posts_per_page' => -1						));						if (sizeof($posts) > 0) {							foreach ($posts as $post) {								$sorted_posts[] = array(									'display_order' => get_field('folio_order', $post->ID),									'title' => $post->post_title,									'post' => $post,								);							}							// sort by display_order and then title							usort($sorted_posts, 'post_compare');							// set default Folio image path as the default image of the first post in category							foreach ($sorted_posts as $item) {								$useAsDefaultImage = get_field('folio_default_image', $item['post']->ID);								if ($folioImagePath == '' && $useAsDefaultImage && $useAsDefaultImage[0] == 'Yes') {									$folioImagePath = get_the_post_thumbnail_url($item['post']->ID, 'single-post-thumbnail');									$folioImageTitle = empty(get_post(get_post_thumbnail_id($item['post']->ID))->post_title) ? $folioName : get_post(get_post_thumbnail_id($item['post']->ID))->post_title;								}							}							if (empty($folioImagePath)) {								$folioImagePath = '/wp-content/uploads/2021/02/Ayin_Glyph_Black.png';								$folioImageTitle = $folioName;							}						}						if ($firstItem) {							echo '	<li id="folioParent' . $childID . '" class="FolioParentTitle" data-thumbnail="' . esc_attr($folioImagePath) . '" data-title="' . esc_attr($folioImageTitle) . '"><a href="javascript:toggle_folio(' . $childID . ', \'' . $child_cat['cat']->slug . '\', false, true);" class="ArrowDown">' . esc_html($folioName) . '</a>';							if ($folioDate) echo ' <span class="FolioDate"> &mdash; ' . $folioDate->format('F j, Y') . '</span>';							echo '		<ul id="folioList' . $childID . '" class="FolioArticleTitles">';							$defaultImagePath = $folioImagePath;							$defaultCaption = $folioImageTitle;							$firstItem = false;							$firstCatId = $childID;						} else {							echo '	<li id="folioParent' . $childID . '" class="FolioParentTitle" data-thumbnail="' . esc_attr($folioImagePath) . '" data-title="' . esc_attr($folioImageTitle) . '"><a href="javascript:toggle_folio(' . $childID . ', \'' . $child_cat['cat']->slug . '\', false, true);" class="ArrowRight">' . esc_html($folioName) . '</a>';							if ($folioDate) echo ' <span class="FolioDate"> &mdash; ' . $folioDate->format('F j, Y') . '</span>';							echo '		<ul id="folioList' . $childID . '" class="FolioArticleTitles" style="display: none;">';						}						foreach ($sorted_posts as $item) {							$folioTitle = get_the_title($item['post']->ID);							$folioPermalink = get_permalink($item['post']->ID);							$folioThumbnail = get_the_post_thumbnail_url($item['post']->ID, 'single-post-thumbnail');							$folioThumbnailTitle = empty(get_post(get_post_thumbnail_id($item['post']->ID))->post_title) ? $folioTitle : get_post(get_post_thumbnail_id($item['post']->ID))->post_title;							$journalAuthor = get_field('artist_name', $item['post']->ID);							$folioAuthor = get_field('folio_artist_name', $item['post']->ID);							$columnAuthor = get_field('column_author_name', $item['post']->ID);							if (!empty ($journalAuthor)) {								$postAuthor = $journalAuthor;							} elseif (!empty ($folioAuthor)) {								$postAuthor = $folioAuthor;							} elseif (!empty ($columnAuthor)) {								$postAuthor = $columnAuthor;							} else {								$postAuthor = '';							}							echo('<li class="folio-article-preview" data-thumbnail="' . esc_attr($folioThumbnail) . '" data-title="' . esc_attr($folioThumbnailTitle) . '"><a href="' . $folioPermalink . '">' . esc_html($folioTitle) . '&nbsp;&nbsp;&ndash;&nbsp;&nbsp;' . $postAuthor . '</a><img src="' . esc_attr($folioThumbnail) . '"></li>');						}						wp_reset_postdata();						echo '		</ul>';						echo '	</li>';					}					echo('</ul>');					echo(					'		</div>							<div class="folios-column folio-preview">								<img id="folio-work-preview"/>								<p id="folio-work-title"></p>							</div>						</div>					</div>					');				}				endwhile; // End of the loop. ?>				<script>					let currentItem = <?php echo $firstCatId; ?>;					let freezeToggle = false;					function toggle_folio(flid, fs, scrollTo=false, updateHash=false) {						if (!freezeToggle) {							freezeToggle = true;							let parentLink = jQuery('#folioParent' + flid + ' > a');							let list = jQuery('#folioList' + flid);							if (list.is(':visible')) {								parentLink.removeClass('ArrowDown');								parentLink.addClass('ArrowRight');								currentItem = 0;							} else {								if (currentItem > 0) {									let oldLink = jQuery('#folioParent' + currentItem + ' > a');									let oldList = jQuery('#folioList' + currentItem);									oldLink.removeClass('ArrowDown');									oldLink.addClass('ArrowRight');									oldList.slideToggle('slow');								}								parentLink.removeClass('ArrowRight');								parentLink.addClass('ArrowDown');								currentItem = flid;							}							if (scrollTo) {								list.slideToggle('slow', function() {									jQuery('html, body').animate({										scrollTop: jQuery('#folioParent' + flid).offset().top - jQuery('#masthead').outerHeight()									}, 1000);									freezeToggle = false;								});							} else {								list.slideToggle('slow', function() {									freezeToggle = false;								});							}							if (updateHash) window.location.hash = '#' + fs;						}					}					jQuery(function() {						let folioPreview = document.getElementById('folio-work-preview');						let folioPreviewTitle = document.getElementById('folio-work-title');						if (folioPreview && folioPreviewTitle) {<?php							if (!empty($defaultImagePath)) { ?>								folioPreview.src = '<?php echo esc_js($defaultImagePath); ?>';<?php							} else { ?>								folioPreview.src = '/wp-content/uploads/2021/02/Ayin_Glyph_Black.png';<?php							}							if (!empty($defaultCaption)) { ?>								folioPreviewTitle.innerHTML = '<?php echo esc_js($defaultCaption); ?>';<?php							} else { ?>								folioPreviewTitle.innerHTML = `Ayin | Folio`;<?php							} ?>							jQuery('li.folio-article-preview').each(function() {								let thumb = jQuery(this).data('thumbnail');								let title = jQuery(this).data('title');								jQuery(this).children('a').mouseover(function() {									folioPreview.src = thumb;									folioPreviewTitle.innerHTML = title;								});							});							jQuery('li.FolioParentTitle').each(function() {								let thumb = jQuery(this).data('thumbnail');								let title = jQuery(this).data('title');								jQuery(this).children('a').mouseover(function() {									folioPreview.src = thumb;									folioPreviewTitle.innerHTML = title;								});							});						}						// check if there is a hash associated with URL; is so, grab link, check if a category ID, and then open that category, and scroll down						if (window.location.hash) {							let hash = window.location.hash.toLowerCase();							if (hash.indexOf('#') === 0) {								let catId = 0;								let folioSlug = hash.substr(1);								<?php echo $folioParentJS; ?>								if (catId > 0) {									if (jQuery('#folioParent' + catId).length) {										if (catId !== <?php echo $firstCatId; ?>) {											toggle_folio(catId, folioSlug, true, false);										} else {											jQuery('html, body').animate({												scrollTop: jQuery('#folioParent' + catId).offset().top - jQuery('#masthead').outerHeight()											}, 1000);										}									}								}							}						}					});				</script>							</div>		</article><!-- #post-<?php the_ID(); ?> -->	</main><!-- #main --></section><!-- #primary --><?phpget_footer();// compare by datefunction date_compare($element1, $element2) {	$datetime1 = strtotime($element1['d']);	$datetime2 = strtotime($element2['d']);	return $datetime2 - $datetime1;}// compare by display order first; if those are equal, then display by title alphabeticallyfunction post_compare($element1, $element2) {	$displayOrder1 = $element1['display_order'];	$displayOrder2 = $element2['display_order'];	if (empty($displayOrder1)) {		$displayOrder1 = 100;	} else {		$displayOrder1 = intval($displayOrder1);	}	if (empty($displayOrder2)) {		$displayOrder2 = 100;	} else {		$displayOrder2 = intval($displayOrder2);	}	if ($displayOrder1 == $displayOrder2) {		return strcmp($element1['title'], $element2['title']);	} else {		return $displayOrder1 - $displayOrder2;	}}